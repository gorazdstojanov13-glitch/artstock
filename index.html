<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FX Paint Studio</title>
    <style>
        body { margin: 0; overflow: hidden; background: #121212; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; height: 100vh; }
        
        /* Top Effects Bar */
        .effects-bar {
            background: #222;
            padding: 10px;
            display: flex;
            justify-content: center;
            gap: 20px;
            border-bottom: 2px solid #333;
            color: white;
            font-size: 13px;
        }

        canvas { background: white; cursor: crosshair; flex-grow: 1; touch-action: none; }

        /* Bottom UI Bar */
        .toolbar {
            background: #1a1a1a;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
            color: white;
            flex-wrap: wrap;
        }

        .tool-group { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        label { font-size: 9px; text-transform: uppercase; color: #888; }
        
        input[type="color"] { border: none; width: 35px; height: 35px; cursor: pointer; background: none; }
        select, button, input[type="range"] { padding: 6px; border-radius: 5px; border: none; background: #333; color: white; cursor: pointer; }
        button:hover { background: #555; }
        .btn-save { background: #27ae60 !important; }
        .active { background: #007bff !important; }
    </style>
</head>
<body>

    <div class="effects-bar">
        <div class="tool-group">
            <label>Image Blur</label>
            <input type="range" id="globalBlur" min="0" max="20" value="0">
        </div>
        <button onclick="applyEffect('invert(100%)')">Invert Colors</button>
        <button onclick="applyEffect('sepia(100%)')">Vintage Sepia</button>
        <button onclick="resetEffects()">Reset Image</button>
        <button id="rainbowBtn">Rainbow: OFF</button>
    </div>

    <canvas id="canvas"></canvas>

    <div class="toolbar">
        <div class="tool-group">
            <label>Color</label>
            <input type="color" id="colorPicker" value="#000000">
        </div>
        <div class="tool-group">
            <label>Tool</label>
            <select id="mainMode">
                <option value="brush">Brush</option>
                <option value="fill">Fill Bucket</option>
            </select>
        </div>
        <div class="tool-group">
            <label>Style</label>
            <select id="brushType">
                <option value="round">Round</option>
                <option value="pixel">Pixel</option>
                <option value="grass">Grass</option>
                <option value="lol">LOL</option>
            </select>
        </div>
        <div class="tool-group">
            <label>Size</label>
            <input type="range" id="sizeSlider" min="1" max="100" value="10">
        </div>
        <button id="eraserBtn">Eraser</button>
        <button id="clearBtn" style="background: #c0392b;">Clear</button>
        <button class="btn-save" id="saveBtn">Save Image</button>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const colorPicker = document.getElementById('colorPicker');
        const sizeSlider = document.getElementById('sizeSlider');
        const brushType = document.getElementById('brushType');
        const mainMode = document.getElementById('mainMode');
        const globalBlur = document.getElementById('globalBlur');
        const rainbowBtn = document.getElementById('rainbowBtn');

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight - 150; // Adjust for UI bars

        let painting = false;
        let isEraser = false;
        let isRainbow = false;
        let hue = 0;

        // --- Drawing Logic ---
        function startPosition(e) {
            if (mainMode.value === 'fill') {
                floodFill(Math.floor(e.offsetX), Math.floor(e.offsetY), hexToRgb(colorPicker.value));
                return;
            }
            painting = true;
            draw(e);
        }

        function draw(e) {
            if (!painting || mainMode.value === 'fill') return;

            ctx.lineWidth = sizeSlider.value;
            ctx.lineCap = 'round';
            ctx.globalCompositeOperation = isEraser ? 'destination-out' : 'source-over';
            
            let color = colorPicker.value;
            if (isRainbow && !isEraser) {
                color = `hsl(${hue}, 100%, 50%)`;
                hue = (hue + 5) % 360;
            }
            ctx.strokeStyle = color;
            ctx.fillStyle = color;

            if (!isEraser && brushType.value === 'pixel') {
                const s = parseInt(sizeSlider.value);
                ctx.fillRect(Math.floor(e.offsetX/s)*s, Math.floor(e.offsetY/s)*s, s, s);
            } else if (!isEraser && brushType.value === 'lol') {
                ctx.font = `${sizeSlider.value}px Impact`;
                ctx.fillText("LOL", e.offsetX, e.offsetY);
            } else {
                ctx.lineTo(e.offsetX, e.offsetY);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(e.offsetX, e.offsetY);
            }
        }

        // --- Interesting Effects ---
        globalBlur.addEventListener('input', () => {
            canvas.style.filter = `blur(${globalBlur.value}px)`;
        });

        function applyEffect(effect) {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            tempCtx.filter = effect;
            tempCtx.drawImage(canvas, 0, 0);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(tempCanvas, 0, 0);
        }

        function resetEffects() {
            canvas.style.filter = 'none';
            globalBlur.value = 0;
        }

        rainbowBtn.addEventListener('click', () => {
            isRainbow = !isRainbow;
            rainbowBtn.innerText = isRainbow ? "Rainbow: ON" : "Rainbow: OFF";
            rainbowBtn.classList.toggle('active');
        });

        // --- FIXED Flood Fill ---
        function hexToRgb(hex) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return [r, g, b, 255];
        }

        function floodFill(startX, startY, fillColor) {
            const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imgData.data;
            const startIdx = (startY * canvas.width + startX) * 4;
            const startR = data[startIdx], startG = data[startIdx+1], startB = data[startIdx+2], startA = data[startIdx+3];

            if (startR === fillColor[0] && startG === fillColor[1] && startB === fillColor[2]) return;

            const queue = [[startX, startY]];
            while(queue.length > 0) {
                const [x, y] = queue.shift();
                const idx = (y * canvas.width + x) * 4;

                if (x < 0 || x >= canvas.width || y < 0 || y >= canvas.height) continue;
                if (data[idx] !== startR || data[idx+1] !== startG || data[idx+2] !== startB) continue;

                data[idx] = fillColor[0]; data[idx+1] = fillColor[1]; data[idx+2] = fillColor[2]; data[idx+3] = 255;

                queue.push([x+1, y], [x-1, y], [x, y+1], [x, y-1]);
            }
            ctx.putImageData(imgData, 0, 0);
        }

        // --- Save & Events ---
        document.getElementById('saveBtn').addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = 'my-art.png';
            link.href = canvas.toDataURL();
            link.click();
        });

        canvas.addEventListener('mousedown', startPosition);
        canvas.addEventListener('mousemove', draw);
        window.addEventListener('mouseup', () => { painting = false; ctx.beginPath(); });
        document.getElementById('clearBtn').onclick = () => ctx.clearRect(0,0,canvas.width,canvas.height);
        document.getElementById('eraserBtn').onclick = () => { isEraser = !isEraser; document.getElementById('eraserBtn').classList.toggle('active'); };
    </script>
</body>
</html>
